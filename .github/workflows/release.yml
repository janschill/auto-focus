name: Release

on:
  push:
    branches:
      - main
    paths:
      # Only run when macOS app project file changes (MARKETING_VERSION)
      - "auto-focus.xcodeproj/project.pbxproj"
      # Also run when app source code changes (in case version was bumped in a previous commit)
      - "auto-focus/**"
  workflow_dispatch: # Allow manual triggering for testing

jobs:
  release:
    name: Build, Sign, Notarize, and Release
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0 # Full history needed for git tags
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch all tags
        run: |
          git fetch --tags --force
          echo "âœ… Fetched all tags"

      - name: Check if MARKETING_VERSION changed
        id: version_check
        run: |
          # Get current MARKETING_VERSION from project file
          CURRENT_VERSION=$(grep -m 1 "MARKETING_VERSION = " auto-focus.xcodeproj/project.pbxproj | sed 's/.*MARKETING_VERSION = \([^;]*\);.*/\1/' | head -n 1)

          # Get latest tag
          LATEST_TAG=$(git tag -l "v1.*.*" --sort=-version:refname | head -n 1)

          if [ -z "$LATEST_TAG" ]; then
            # No tag exists, this is the first release
            echo "version_changed=true" >> $GITHUB_OUTPUT
            echo "âœ… No existing tag found - will create first release"
            exit 0
          fi

          # Extract version from tag (remove 'v' prefix)
          TAG_VERSION=${LATEST_TAG#v}

          # Compare versions
          if [ "$CURRENT_VERSION" != "$TAG_VERSION" ]; then
            echo "version_changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Version changed: $TAG_VERSION -> $CURRENT_VERSION"
          else
            echo "version_changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  Version unchanged ($CURRENT_VERSION) - skipping release"
            echo "   To release, bump MARKETING_VERSION in auto-focus.xcodeproj/project.pbxproj"
          fi

      - name: Select Xcode version
        if: steps.version_check.outputs.version_changed == 'true'
        run: sudo xcode-select -switch /Applications/Xcode.app/Contents/Developer

      - name: Clear DerivedData cache for fresh build
        if: steps.version_check.outputs.version_changed == 'true'
        run: |
          # Remove any cached DerivedData to ensure fresh build
          rm -rf ~/Library/Developer/Xcode/DerivedData/auto-focus-*
          rm -rf build/DerivedData
          echo "âœ… Cleared DerivedData cache for fresh build"

      - name: Resolve package dependencies
        if: steps.version_check.outputs.version_changed == 'true'
        run: xcodebuild -resolvePackageDependencies -project auto-focus.xcodeproj

      - name: Import code signing certificate
        if: steps.version_check.outputs.version_changed == 'true'
        uses: apple-actions/import-codesign-certs@v2
        id: import-certs
        with:
          p12-file-base64: ${{ secrets.APPLE_CERTIFICATE }}
          p12-password: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}

      - name: Verify certificate import
        if: steps.version_check.outputs.version_changed == 'true'
        run: |
          echo "Available signing identities:"
          security find-identity -v -p codesigning

          # Check specifically for Developer ID Application
          if ! security find-identity -v -p codesigning | grep -q "Developer ID Application"; then
            echo "âŒ Developer ID Application certificate not found"
            echo "All identities:"
            security find-identity -v -p codesigning
            exit 1
          fi

          echo "âœ… Certificate verified"

      - name: Calculate version
        id: version
        if: steps.version_check.outputs.version_changed == 'true'
        run: |
          # Read MARKETING_VERSION from project file (we already verified it changed)
          PROJECT_VERSION=$(grep -m 1 "MARKETING_VERSION = " auto-focus.xcodeproj/project.pbxproj | sed 's/.*MARKETING_VERSION = \([^;]*\);.*/\1/' | head -n 1)

          echo "version=$PROJECT_VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$PROJECT_VERSION" >> $GITHUB_OUTPUT
          echo "âœ… Using MARKETING_VERSION: $PROJECT_VERSION"

      - name: Auto-increment build number
        if: steps.version_check.outputs.version_changed == 'true'
        run: |
          # Get current build number from project file
          CURRENT_BUILD=$(grep -m 1 "CURRENT_PROJECT_VERSION = " auto-focus.xcodeproj/project.pbxproj | sed 's/.*CURRENT_PROJECT_VERSION = \([^;]*\);.*/\1/' | head -n 1 | tr -d ' ')

          # Increment build number
          NEW_BUILD=$((CURRENT_BUILD + 1))

          echo "ðŸ“¦ Incrementing build number: $CURRENT_BUILD -> $NEW_BUILD"

          # Update build number in all configurations (Debug, Release, Test targets)
          # Use sed to replace all occurrences of CURRENT_PROJECT_VERSION = <number> with the new build number
          sed -i.bak "s/CURRENT_PROJECT_VERSION = [0-9]*/CURRENT_PROJECT_VERSION = $NEW_BUILD/g" auto-focus.xcodeproj/project.pbxproj
          rm -f auto-focus.xcodeproj/project.pbxproj.bak

          # Verify the change
          VERIFIED_BUILD=$(grep -m 1 "CURRENT_PROJECT_VERSION = " auto-focus.xcodeproj/project.pbxproj | sed 's/.*CURRENT_PROJECT_VERSION = \([^;]*\);.*/\1/' | head -n 1 | tr -d ' ')
          if [ "$VERIFIED_BUILD" = "$NEW_BUILD" ]; then
            echo "âœ… Build number updated successfully to $NEW_BUILD"
          else
            echo "âŒ Failed to update build number. Expected $NEW_BUILD, got $VERIFIED_BUILD"
            exit 1
          fi

          # Commit the build number change
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add auto-focus.xcodeproj/project.pbxproj
          git commit -m "chore: Auto-increment build number to $NEW_BUILD" || echo "No changes to commit (build number already updated)"

      - name: Build and archive app
        if: steps.version_check.outputs.version_changed == 'true'
        env:
          HMAC_SECRET: ${{ secrets.HMAC_SECRET }}
        run: |
          # List available certificates for debugging
          echo "Checking for signing certificate before build..."
          security find-identity -v -p codesigning | grep "Developer ID Application" || echo "Warning: Certificate not found"

          # Clean build to ensure no stale artifacts
          xcodebuild clean \
            -project auto-focus.xcodeproj \
            -scheme auto-focus \
            -configuration Release || true

          # Build archive with fresh DerivedData
          xcodebuild archive \
            -project auto-focus.xcodeproj \
            -scheme auto-focus \
            -configuration Release \
            -archivePath build/auto-focus.xcarchive \
            -derivedDataPath build/DerivedData \
            CODE_SIGN_IDENTITY="Developer ID Application: Jan Schill (LKQJ2JG34Y)" \
            CODE_SIGN_STYLE=Manual \
            DEVELOPMENT_TEAM=LKQJ2JG34Y \
            HMAC_SECRET="$HMAC_SECRET" || exit $?

          echo "âœ… Archive built successfully"

      - name: Extract app from archive
        if: steps.version_check.outputs.version_changed == 'true'
        run: |
          mkdir -p build
          cp -R build/auto-focus.xcarchive/Products/Applications/auto-focus.app build/auto-focus_temp.app
          echo "App extracted to build/auto-focus_temp.app"

      - name: Code sign app
        if: steps.version_check.outputs.version_changed == 'true'
        run: |
          codesign --sign "Developer ID Application: Jan Schill (LKQJ2JG34Y)" \
            --timestamp \
            --options runtime \
            --deep \
            --force \
            build/auto-focus_temp.app

          # Verify signature
          codesign --verify --verbose build/auto-focus_temp.app
          echo "âœ… Code signing verified"

      - name: Create ZIP for notarization
        if: steps.version_check.outputs.version_changed == 'true'
        run: |
          cd build
          zip -r auto-focus_notarization.zip auto-focus_temp.app
          echo "Created notarization ZIP"

      - name: Notarize app
        if: steps.version_check.outputs.version_changed == 'true'
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          # Submit for notarization
          xcrun notarytool submit build/auto-focus_notarization.zip \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_APP_SPECIFIC_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait

          echo "âœ… Notarization successful"

      - name: Staple notarization ticket
        if: steps.version_check.outputs.version_changed == 'true'
        run: |
          xcrun stapler staple build/auto-focus_temp.app
          xcrun stapler validate build/auto-focus_temp.app
          echo "âœ… Notarization ticket stapled"

      - name: Package app for distribution
        if: steps.version_check.outputs.version_changed == 'true'
        run: |
          mkdir -p docs/downloads
          VERSION="${{ steps.version.outputs.version }}"
          ZIP_NAME="Auto-Focus-v${VERSION}.zip"

          # Rename app for distribution (remove _temp suffix)
          cd build
          cp -R auto-focus_temp.app auto-focus.app

          # Create versioned distribution ZIP
          zip -r ../docs/downloads/${ZIP_NAME} auto-focus.app

          # Also create a symlink for backward compatibility (GitHub Pages doesn't support symlinks, so copy instead)
          cd ../docs/downloads
          cp ${ZIP_NAME} Auto-Focus.zip
          cd ../..

          echo "âœ… Created ${ZIP_NAME} and Auto-Focus.zip (for backward compatibility)"

          # Verify ZIP contents
          if unzip -l docs/downloads/${ZIP_NAME} | grep -q "auto-focus.app/"; then
            echo "âœ… App ZIP created successfully"
          else
            echo "âŒ ERROR: ZIP does not contain auto-focus.app"
            echo "ZIP contents:"
            unzip -l docs/downloads/${ZIP_NAME} | head -20
            exit 1
          fi

      - name: Package browser extension
        if: steps.version_check.outputs.version_changed == 'true'
        run: |
          mkdir -p docs/downloads
          cd auto-focus-browser-extension
          zip -r ../docs/downloads/auto-focus-extension.zip chrome/ -x "*.DS_Store*" "*/.git*"
          echo "âœ… Extension packaged"

      - name: Generate version.json
        if: steps.version_check.outputs.version_changed == 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          COMMIT_HASH=$(git rev-parse --short HEAD)
          ZIP_NAME="Auto-Focus-v${VERSION}.zip"

          cat > docs/downloads/version.json << EOF
          {
            "version": "$VERSION",
            "build_date": "$BUILD_DATE",
            "commit_hash": "$COMMIT_HASH",
            "app_zip": "${ZIP_NAME}",
            "extension_zip": "auto-focus-extension.zip",
            "download_url": "https://auto-focus.app/downloads/${ZIP_NAME}",
            "min_macos": "14.0"
          }
          EOF

          echo "âœ… Version file generated"
          echo "Version: $VERSION"
          echo "Build date: $BUILD_DATE"
          echo "Commit: $COMMIT_HASH"
          echo "ZIP filename: ${ZIP_NAME}"

      - name: Create git tag
        if: steps.version_check.outputs.version_changed == 'true'
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # Check if tag already exists (shouldn't happen, but be safe)
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "âš ï¸  Tag $TAG already exists - skipping tag creation"
          else
            git tag -a "$TAG" -m "Release $TAG"
            echo "âœ… Created tag: $TAG"
          fi

      - name: Commit distribution files
        if: steps.version_check.outputs.version_changed == 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          ZIP_NAME="Auto-Focus-v${VERSION}.zip"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Remove old versioned zip files from git tracking (keep only the latest)
          git rm --cached --ignore-unmatch docs/downloads/Auto-Focus-v*.zip 2>/dev/null || true

          # Add new distribution files (versioned zip, backward-compat zip, extension, and version.json)
          git add docs/downloads/${ZIP_NAME} \
                  docs/downloads/Auto-Focus.zip \
                  docs/downloads/auto-focus-extension.zip \
                  docs/downloads/version.json \
                  auto-focus.xcodeproj/project.pbxproj

          # Commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Release ${{ steps.version.outputs.tag }}: Update distribution files"
            echo "âœ… Committed distribution files"
          fi

      - name: Generate release notes
        id: release_notes
        if: steps.version_check.outputs.version_changed == 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${{ steps.version.outputs.tag }}"
          BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          COMMIT_HASH=$(git rev-parse --short HEAD)

          cat > /tmp/release_notes.md << EOF
          ## Auto-Focus $TAG

          ### Release Information
          - **Version**: $VERSION
          - **Build Date**: $BUILD_DATE
          - **Commit**: $COMMIT_HASH

          ### Installation
          1. Download Auto-Focus.zip
          2. Extract and move Auto-Focus.app to Applications
          3. Install the included Shortcut
          4. Launch and configure focus apps

          ### System Requirements
          - macOS Sonoma (14.0) or later
          - Chrome browser (for extension)

          ---

          ðŸ”— **Website**: https://auto-focus.app
          EOF

          echo "âœ… Release notes generated"

      - name: Create GitHub release
        if: steps.version_check.outputs.version_changed == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.tag }}
          body_path: /tmp/release_notes.md
          files: |
            docs/downloads/Auto-Focus-v${{ steps.version.outputs.version }}.zip
            docs/downloads/Auto-Focus.zip
            docs/downloads/auto-focus-extension.zip
            docs/downloads/version.json
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Push tag and commits
        if: steps.version_check.outputs.version_changed == 'true'
        run: |
          TAG="${{ steps.version.outputs.tag }}"

          # Push tag first
          git push origin "$TAG" || echo "Tag may already exist"

          # Check if there are commits to push
          if git diff --quiet HEAD origin/main 2>/dev/null; then
            echo "No new commits to push"
          else
            git push origin main
            echo "âœ… Pushed commits to main"
          fi

      - name: Cleanup
        if: always()
        run: |
          # The apple-actions/import-codesign-certs action handles cleanup automatically
          echo "âœ… Cleanup complete"
